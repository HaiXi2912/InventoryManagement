import{d as Z,r as f,l as ee,m as E,o as te,p as ae,q as le,a as C,c as M,b as c,e as a,w as l,f as n,h as _,F as se,g as oe,k as m,t as i,n as ne,E as p,i as de,j as W,s as ue,_ as ie}from"./index-B2xfaXjR.js";const re={class:"checkout"},ce={style:{"margin-top":"10px"}},me={class:"item"},pe=["src"],ve={class:"name"},fe={class:"spec"},_e={class:"pay-tools"},ye={class:"balance"},be={key:0,class:"tip"},ge={class:"total"},we={class:"recharge"},Ve=Z({__name:"Checkout",setup(ke){const R=de(),I=f(!1),U=f([]),y=f(null),N=f(!1),o=f({receiver_name:"",phone:"",province:"",city:"",district:"",detail:"",is_default:!1}),$=f(!0),B=ee(),w=f([]),S=E(()=>w.value.reduce((s,e)=>s+Number(e.amount||0),0)),J=E(()=>S.value.toFixed(2));function K(){try{const s=localStorage.getItem("token")||"",e=JSON.parse(decodeURIComponent(escape(window.atob(s.split(".")[1]))));return Number(e?.id||e?.user_id||null)||null}catch{return null}}function j(s){if(!s)return"https://via.placeholder.com/120x120?text=SKU";const e=String(s);return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")?e:/^\d+x\d+(\?.*)?$/.test(e)?`https://via.placeholder.com/${e}`:"https://via.placeholder.com/120x120?text=SKU"}async function q(){I.value=!0;try{try{const e=await _.get("/api/addresses");if(e.data?.success){U.value=e.data.data||[];const u=U.value.find(d=>d.is_default);y.value=u?.id||U.value[0]?.id||null}}catch{U.value=[],y.value=null}const s=[];for(const e of B.items)try{const{data:u}=await _.get(`/api/catalog/sku/${e.sku_id}`);if(u?.success){const{sku:d,product:r}=u.data,k=r?.media?.find?.(h=>h.is_main)||r?.media?.[0],v=j(k?.url||r?.image_url),x=e.quantity;s.push({sku_id:d.id,product_id:d.product_id,name:r?.name||"",size:d.size,color:d.color,barcode:d.barcode,image:v,price:Number(d.retail_price||0),quantity:x,amount:+(Number(d.retail_price||0)*Number(x)).toFixed(2)})}}catch{}w.value=s}finally{I.value=!1}}async function L(s){const{data:e}=await _.post(`/api/addresses/${s}/default`);e?.success&&(p.success("已设为默认"),await q())}async function O(){try{const{data:s}=await _.post("/api/addresses",o.value);s?.success?(p.success("已保存"),N.value=!1,await q()):p.error(s?.message||"保存失败")}catch(s){const e=s?.response?.status===401?"未登录或会话已过期，请先登录":s?.response?.data?.message||"保存失败，稍后重试";p.error(e)}}const z=f({balance:0,transactions:[]}),V=f(null);async function F(){try{const{data:s}=await _.get("/api/wallet/me");s?.success&&(z.value={balance:Number(s.data?.balance||0),transactions:s.data?.transactions||[]})}catch{}}async function T(){if(!V.value||V.value<=0)return p.warning("请输入正确金额");const{data:s}=await _.post("/api/wallet/recharge",{amount:V.value});s?.success&&(p.success("充值成功"),await F(),V.value=null)}te(async()=>{await q(),await F()});async function G(){if(!y.value)return p.warning("请选择地址");if(!w.value.length)return p.warning("购物车为空");const s={items:w.value.map(u=>({sku_id:u.sku_id,quantity:u.quantity})),address_id:y.value},{data:e}=await _.post("/api/orders/checkout",s);if(e?.success){p.success("订单已创建，准备支付...");const u=e.data.order_id,d=Number(e.data?.pay_amount??S.value);let r=!1;const k=K();if($.value&&z.value.balance>=d&&k)try{(await _.post(`/api/orders/${u}/pay`,{customer_id:k})).data?.success&&(r=!0)}catch{}r||(await _.post(`/api/orders/${u}/pay`)).data?.success&&(r=!0),await F(),r?(p.success("支付成功"),B.clear(),R.push("/orders")):p.error("支付失败，请稍后重试")}}return(s,e)=>{const u=n("el-tag"),d=n("el-link"),r=n("el-radio"),k=n("el-radio-group"),v=n("el-button"),x=n("el-card"),h=n("el-table-column"),H=n("el-table"),D=n("el-col"),A=n("el-switch"),b=n("el-input"),P=n("el-row"),g=n("el-form-item"),Q=n("el-form"),X=n("el-dialog"),Y=le("loading");return ae((C(),M("div",re,[e[23]||(e[23]=c("h2",null,"结算",-1)),a(P,{gutter:20},{default:l(()=>[a(D,{md:16,sm:24},{default:l(()=>[a(x,{shadow:"never",class:"addresses"},{header:l(()=>[...e[13]||(e[13]=[m("收货地址",-1)])]),default:l(()=>[a(k,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t)},{default:l(()=>[(C(!0),M(se,null,oe(U.value,t=>(C(),W(r,{key:t.id,label:t.id},{default:l(()=>[m(i(t.receiver_name)+" / "+i(t.phone)+" / "+i(t.province)+i(t.city)+i(t.district)+" "+i(t.detail)+" ",1),t.is_default?(C(),W(u,{key:0,size:"small",type:"success",style:{"margin-left":"8px"}},{default:l(()=>[...e[14]||(e[14]=[m("默认",-1)])]),_:1})):(C(),W(d,{key:1,type:"primary",underline:!1,style:{"margin-left":"8px"},onClick:ue(xe=>L(t.id),["stop"])},{default:l(()=>[...e[15]||(e[15]=[m("设为默认",-1)])]),_:1},8,["onClick"]))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]),c("div",ce,[a(v,{size:"small",onClick:e[1]||(e[1]=t=>N.value=!0)},{default:l(()=>[...e[16]||(e[16]=[m("新增地址",-1)])]),_:1})])]),_:1}),a(x,{shadow:"never",style:{"margin-top":"16px"}},{header:l(()=>[...e[17]||(e[17]=[m("订单明细",-1)])]),default:l(()=>[a(H,{data:w.value,border:"",size:"small"},{default:l(()=>[a(h,{label:"商品","min-width":"260"},{default:l(({row:t})=>[c("div",me,[c("img",{src:t.image},null,8,pe),c("div",null,[c("div",ve,i(t.name),1),c("div",fe,i(t.size)+" / "+i(t.color)+" （条码："+i(t.barcode)+"）",1)])])]),_:1}),a(h,{prop:"price",label:"单价",width:"120"}),a(h,{prop:"quantity",label:"数量",width:"100"}),a(h,{prop:"amount",label:"小计",width:"120"})]),_:1},8,["data"])]),_:1})]),_:1}),a(D,{md:8,sm:24},{default:l(()=>[a(x,{shadow:"never"},{header:l(()=>[...e[18]||(e[18]=[m("支付",-1)])]),default:l(()=>[c("div",_e,[a(A,{modelValue:$.value,"onUpdate:modelValue":e[2]||(e[2]=t=>$.value=t),"active-text":"使用钱包支付","inactive-text":"常规支付"},null,8,["modelValue"]),c("div",ye,"钱包余额：¥"+i(z.value.balance.toFixed(2)),1),$.value&&z.value.balance<S.value?(C(),M("div",be,"余额不足，将使用常规支付")):ne("",!0)]),c("div",ge,"合计：¥"+i(J.value),1),c("div",we,[a(b,{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=t=>V.value=t),modelModifiers:{number:!0},type:"number",placeholder:"充值金额",style:{width:"140px"}},null,8,["modelValue"]),a(v,{size:"small",onClick:T},{default:l(()=>[...e[19]||(e[19]=[m("充值",-1)])]),_:1})]),a(v,{type:"primary",disabled:!y.value||!w.value.length,onClick:G},{default:l(()=>[...e[20]||(e[20]=[m("提交订单",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),a(X,{modelValue:N.value,"onUpdate:modelValue":e[12]||(e[12]=t=>N.value=t),title:"新增收货地址",width:"520px"},{footer:l(()=>[a(v,{onClick:e[11]||(e[11]=t=>N.value=!1)},{default:l(()=>[...e[21]||(e[21]=[m("取消",-1)])]),_:1}),a(v,{type:"primary",onClick:O},{default:l(()=>[...e[22]||(e[22]=[m("保存",-1)])]),_:1})]),default:l(()=>[a(Q,{model:o.value,"label-width":"90px"},{default:l(()=>[a(g,{label:"收货人"},{default:l(()=>[a(b,{modelValue:o.value.receiver_name,"onUpdate:modelValue":e[4]||(e[4]=t=>o.value.receiver_name=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"电话"},{default:l(()=>[a(b,{modelValue:o.value.phone,"onUpdate:modelValue":e[5]||(e[5]=t=>o.value.phone=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"省"},{default:l(()=>[a(b,{modelValue:o.value.province,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.province=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"市"},{default:l(()=>[a(b,{modelValue:o.value.city,"onUpdate:modelValue":e[7]||(e[7]=t=>o.value.city=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"区/县"},{default:l(()=>[a(b,{modelValue:o.value.district,"onUpdate:modelValue":e[8]||(e[8]=t=>o.value.district=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"详细地址"},{default:l(()=>[a(b,{modelValue:o.value.detail,"onUpdate:modelValue":e[9]||(e[9]=t=>o.value.detail=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"设为默认"},{default:l(()=>[a(A,{modelValue:o.value.is_default,"onUpdate:modelValue":e[10]||(e[10]=t=>o.value.is_default=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])),[[Y,I.value]])}}}),Ce=ie(Ve,[["__scopeId","data-v-d0a536c5"]]);export{Ce as default};
