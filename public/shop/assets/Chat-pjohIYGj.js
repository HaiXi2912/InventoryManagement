import{_ as k,r as o,o as S,c as l,a as r,b as a,n as C,t as u,F as T,g as B,p as x,A as O,y as $,B as I,C as N}from"./index-B2xfaXjR.js";const M={class:"chat"},P={class:"hd"},V={key:0,class:"unread"},j={class:"bubble"},z={class:"role"},A={class:"content"},D={class:"time"},F={class:"ft"},J=["disabled"],K={__name:"Chat",setup(R){const e=o(""),h=o([]),i=o(""),d=o(!1),f=o(0),v=o(null);async function c(s,n={}){const t=localStorage.getItem("token"),m=await fetch(`/api${s}`,{headers:{"Content-Type":"application/json",...t?{Authorization:`Bearer ${t}`}:{}},...n}),b=await m.json().catch(()=>({}));return{status:m.status,body:b}}async function p(){const s=await c("/chats/unread/count");s.status===200&&(f.value=s.body?.data?.unread||0)}function g(){const s=v.value;s&&(s.scrollTop=s.scrollHeight)}async function w(){const s=await c("/chats/sessions/start",{method:"POST",body:JSON.stringify({})});s.status===200&&(e.value=s.body?.data?.session_id)}async function _(){if(!e.value)return;const s=await c(`/chats/sessions/${e.value}/messages`);s.status===200&&(h.value=s.body?.data||[],await I(),g(),await c(`/chats/sessions/${e.value}/read`,{method:"POST"}),await p())}async function y(){if(!(!i.value.trim()||!e.value)){d.value=!0;try{const s=await c(`/chats/sessions/${e.value}/messages`,{method:"POST",body:JSON.stringify({content:i.value})});[200,201].includes(s.status)&&(i.value="",await _())}finally{d.value=!1}}}return S(async()=>{await w(),await _(),await p(),setInterval(async()=>{await _()},5e3)}),(s,n)=>(r(),l("div",M,[a("header",P,[n[1]||(n[1]=a("span",null,"客服聊天",-1)),f.value>0?(r(),l("span",V,"未读 "+u(f.value),1)):C("",!0)]),a("section",{class:"msgs",ref_key:"msgsRef",ref:v},[(r(!0),l(T,null,B(h.value,t=>(r(),l("div",{key:t.id,class:N(["msg",t.role])},[a("div",j,[a("span",z,u(t.role),1),a("span",A,u(t.content),1),a("span",D,u(t.created_at),1)])],2))),128))],512),a("footer",F,[x(a("input",{"onUpdate:modelValue":n[0]||(n[0]=t=>i.value=t),onKeyup:$(y,["enter"]),placeholder:"输入消息，回车发送"},null,544),[[O,i.value]]),a("button",{onClick:y,disabled:d.value},"发送",8,J)])]))}},E=k(K,[["__scopeId","data-v-0c778b64"]]);export{E as default};
