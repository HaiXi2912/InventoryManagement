
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.hurui.me
 */
    
import{d as te,r as d,A as se,c as x,f as a,w as s,P as y,E as _,i,O as ue,o as w,g as ne,Q as oe,R as h,S as E,h as m,_ as ie,J as re,e as de,I as K,t as D,H as me,U as L,v as pe,x as T}from"./index-CdiJTMf6.js";const ve={class:"users-page"},fe={class:"pagination"},H=te({__name:"users",setup(ce){const S=d(!1),I=d([]),N=d(0),C=d(1),B=d(10),U=d(""),$=d(""),z=d(""),M=[{label:"管理员",value:"admin"},{label:"经理",value:"manager"},{label:"员工",value:"staff"},{label:"渠道/代理",value:"agent"},{label:"工厂",value:"factory"}],P=[{label:"启用",value:"active"},{label:"禁用",value:"inactive"},{label:"锁定",value:"locked"}];async function g(){S.value=!0;try{const t=await y.get("/users",{params:{page:C.value,limit:B.value,search:U.value||void 0,role:$.value||void 0,status:z.value||void 0}});if(t.success){const e=(t.data.users||[]).filter(u=>u.role!=="customer");I.value=e,N.value=t.data.pagination.total-((t.data.users||[]).length-e.length)}else throw new Error(t.message||"加载失败")}catch(t){_.error((t==null?void 0:t.message)||"加载失败")}finally{S.value=!1}}function J(){U.value="",$.value="",z.value="",C.value=1,g()}const V=d(!1),k=d(!1),n=d({role:"staff",status:"active"});function Q(){k.value=!1,n.value={role:"staff",status:"active"},V.value=!0}function R(t){k.value=!0;const{id:e,username:u,email:o,real_name:p,phone:v,role:f,status:r}=t;n.value={id:e,username:u,email:o,real_name:p,phone:v,role:f,status:r},V.value=!0}function O(t,e=!1){var v,f;const u={},o=typeof t.username=="string"&&/^[A-Za-z0-9]{3,30}$/.test(t.username),p=typeof t.email=="string"&&/.+@.+\..+/.test(t.email);if(e){if(!o)throw new Error("用户名需为3-30位字母或数字");if(!p)throw new Error("邮箱格式不正确");if(!t.password||!/^(?=.*[A-Za-z])(?=.*\d).{6,}$/.test(t.password))throw new Error("密码需≥6位且包含字母和数字");u.username=t.username,u.email=t.email,u.password=t.password}else o&&(u.username=t.username),p&&(u.email=t.email);return t.real_name!==void 0&&(u.real_name=(v=t.real_name)!=null?v:""),t.phone!==void 0&&(u.phone=(f=t.phone)!=null?f:""),t.role&&(u.role=t.role),t.status&&(u.status=t.status),u}async function q(){try{if(k.value){const t=O(n.value,!1);if(Object.keys(t).length===0){_.info("无变更");return}await y.put("/users/".concat(n.value.id),t),_.success("已保存")}else{const t=O(n.value,!0);await y.post("/users",t),_.success("已创建")}V.value=!1,g()}catch(t){_.error((t==null?void 0:t.message)||"提交失败")}}async function G(t){const e=t.status==="active"?"inactive":"active";try{await y.put("/users/".concat(t.id),{status:e}),t.status=e,_.success("已更新")}catch(u){_.error((u==null?void 0:u.message)||"失败")}}async function W(t){try{const{value:e}=await L.prompt("输入新密码（至少6位，含字母和数字）","重置密码",{inputType:"password",inputPattern:/^(?=.*[A-Za-z])(?=.*\d).{6,}$/});await y.put("/users/".concat(t.id,"/reset-password"),{new_password:e}),_.success("已重置")}catch(e){}}async function X(t){try{await L.confirm("确定禁用用户 ".concat(t.username," 吗？"),"禁用",{type:"warning"}),await y.delete("/users/".concat(t.id)),_.success("已禁用"),g()}catch(e){}}return se(g),(t,e)=>{const u=i("el-input"),o=i("el-form-item"),p=i("el-option"),v=i("el-select"),f=ie,r=i("el-button"),F=i("el-form"),Z=i("el-card"),c=i("el-table-column"),j=i("el-tag"),Y=i("el-table"),ee=i("el-pagination"),le=i("el-dialog"),ae=ue("loading");return w(),x("div",ve,[a(Z,{shadow:"never",class:"mb-2"},{default:s(()=>[a(F,{inline:"",onSubmit:e[3]||(e[3]=ne(()=>{},["prevent"]))},{default:s(()=>[a(o,{label:"关键字"},{default:s(()=>[a(u,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=l=>U.value=l),placeholder:"用户名/姓名/邮箱",style:{width:"220px"},clearable:"",onKeyup:oe(g,["enter","native"])},null,8,["modelValue"])]),_:1}),a(o,{label:"角色"},{default:s(()=>[a(v,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=l=>$.value=l),clearable:"",style:{width:"160px"}},{default:s(()=>[(w(),x(h,null,E(M,l=>a(p,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(o,{label:"状态"},{default:s(()=>[a(v,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=l=>z.value=l),clearable:"",style:{width:"140px"}},{default:s(()=>[(w(),x(h,null,E(P,l=>a(p,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(o,null,{default:s(()=>[a(r,{type:"primary",onClick:g},{default:s(()=>[a(f,{name:"i-ep:search"}),e[16]||(e[16]=m(" 查询",-1))]),_:1}),a(r,{onClick:J},{default:s(()=>[a(f,{name:"i-ep:refresh"}),e[17]||(e[17]=m(" 重置",-1))]),_:1}),a(r,{type:"success",onClick:Q},{default:s(()=>[a(f,{name:"i-ep:plus"}),e[18]||(e[18]=m(" 新建用户",-1))]),_:1})]),_:1})]),_:1})]),_:1}),a(Z,{shadow:"never"},{default:s(()=>[re((w(),K(Y,{data:I.value,border:"",stripe:"",style:{width:"100%"}},{default:s(()=>[a(c,{prop:"id",label:"ID",width:"70"}),a(c,{prop:"username",label:"用户名","min-width":"120"}),a(c,{prop:"real_name",label:"姓名",width:"120"}),a(c,{prop:"email",label:"邮箱","min-width":"160"}),a(c,{prop:"phone",label:"手机",width:"120"}),a(c,{prop:"role",label:"角色",width:"110"},{default:s(({row:l})=>[a(j,null,{default:s(()=>{var b;return[m(D(((b=M.find(A=>A.value===l.role))==null?void 0:b.label)||l.role),1)]}),_:2},1024)]),_:1}),a(c,{prop:"status",label:"状态",width:"100"},{default:s(({row:l})=>[a(j,{type:l.status==="active"?"success":l.status==="locked"?"warning":"info"},{default:s(()=>{var b;return[m(D(((b=P.find(A=>A.value===l.status))==null?void 0:b.label)||l.status),1)]}),_:2},1032,["type"])]),_:1}),a(c,{prop:"last_login_at",label:"最近登录",width:"160"}),a(c,{label:"操作",width:"260",fixed:"right"},{default:s(({row:l})=>[a(r,{size:"small",type:"primary",onClick:b=>R(l)},{default:s(()=>[a(f,{name:"i-ep:edit"}),e[19]||(e[19]=m(" 编辑",-1))]),_:1},8,["onClick"]),a(r,{size:"small",onClick:b=>G(l)},{default:s(()=>[m(D(l.status==="active"?"禁用":"启用"),1)]),_:2},1032,["onClick"]),a(r,{size:"small",type:"warning",onClick:b=>W(l)},{default:s(()=>[...e[20]||(e[20]=[m("重置密码",-1)])]),_:1},8,["onClick"]),a(r,{size:"small",type:"danger",onClick:b=>X(l)},{default:s(()=>[...e[21]||(e[21]=[m("禁用",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ae,S.value]]),de("div",fe,[a(ee,{"current-page":C.value,"onUpdate:currentPage":e[4]||(e[4]=l=>C.value=l),"page-size":B.value,"onUpdate:pageSize":e[5]||(e[5]=l=>B.value=l),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:N.value,onCurrentChange:g,onSizeChange:e[6]||(e[6]=()=>{C.value=1,g()})},null,8,["current-page","page-size","total"])])]),_:1}),a(le,{modelValue:V.value,"onUpdate:modelValue":e[15]||(e[15]=l=>V.value=l),title:k.value?"编辑用户":"新建用户",width:"560px","close-on-click-modal":!1},{footer:s(()=>[a(r,{onClick:e[14]||(e[14]=l=>V.value=!1)},{default:s(()=>[...e[22]||(e[22]=[m("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:q},{default:s(()=>[...e[23]||(e[23]=[m("保存",-1)])]),_:1})]),default:s(()=>[a(F,{"label-width":"100px"},{default:s(()=>[a(o,{label:"用户名"},{default:s(()=>[a(u,{modelValue:n.value.username,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.username=l),disabled:k.value},null,8,["modelValue","disabled"])]),_:1}),a(o,{label:"邮箱"},{default:s(()=>[a(u,{modelValue:n.value.email,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.email=l)},null,8,["modelValue"])]),_:1}),a(o,{label:"姓名"},{default:s(()=>[a(u,{modelValue:n.value.real_name,"onUpdate:modelValue":e[9]||(e[9]=l=>n.value.real_name=l)},null,8,["modelValue"])]),_:1}),a(o,{label:"手机"},{default:s(()=>[a(u,{modelValue:n.value.phone,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.phone=l),placeholder:"11位手机号或留空"},null,8,["modelValue"])]),_:1}),a(o,{label:"角色"},{default:s(()=>[a(v,{modelValue:n.value.role,"onUpdate:modelValue":e[11]||(e[11]=l=>n.value.role=l),style:{width:"200px"}},{default:s(()=>[(w(),x(h,null,E(M,l=>a(p,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(o,{label:"状态"},{default:s(()=>[a(v,{modelValue:n.value.status,"onUpdate:modelValue":e[12]||(e[12]=l=>n.value.status=l),style:{width:"200px"}},{default:s(()=>[(w(),x(h,null,E(P,l=>a(p,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),k.value?me("",!0):(w(),K(o,{key:0,label:"初始密码"},{default:s(()=>[a(u,{modelValue:n.value.password,"onUpdate:modelValue":e[13]||(e[13]=l=>n.value.password=l),type:"password",placeholder:"至少6位且包含字母和数字"},null,8,["modelValue"])]),_:1}))]),_:1})]),_:1},8,["modelValue","title"])])}}});typeof T=="function"&&T(H);const _e=pe(H,[["__scopeId","data-v-04ca07af"]]);export{_e as default};
