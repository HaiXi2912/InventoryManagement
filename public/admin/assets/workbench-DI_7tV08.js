
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.hurui.me
 */
    
import{P as o,d as le,r as _,F as A,A as ne,W as oe,c as y,e as l,f as n,w as i,R as H,S as K,h as u,t as p,I as N,H as S,j as ie,Q as ue,q as re,s as de,i as k,o as c,n as P,g as j,v as me,x as E}from"./index-CdiJTMf6.js";const g={listAgentSessions:()=>o.get("/chats/sessions"),listMySessions:()=>o.get("/chats/my/sessions"),getSessionMessages:a=>o.get("/chats/sessions/".concat(a,"/messages")),sendMessage:(a,m)=>o.post("/chats/sessions/".concat(a,"/messages"),m),markRead:a=>o.post("/chats/messages/".concat(a,"/read")),markSessionRead:a=>o.post("/chats/sessions/".concat(a,"/read")),startSession:a=>o.post("/chats/sessions/start",a),unreadCount:()=>o.get("/chats/unread/count"),readAll:()=>o.post("/chats/read-all")},ce={list:a=>o.get("/after-sales",{params:a}),detail:a=>o.get("/after-sales/".concat(a)),approve:a=>o.post("/after-sales/".concat(a,"/approve"),{}),inspect:(a,m)=>o.post("/after-sales/".concat(a,"/inspect"),m),complete:(a,m)=>o.post("/after-sales/".concat(a,"/complete"),m||{}),cancel:a=>o.post("/after-sales/".concat(a,"/cancel"),{}),walletTransfer:a=>o.post("/after-sales/wallet/transfer",a)},pe={class:"cs"},ve={class:"sidebar"},_e={class:"tools"},fe=["onClick"],ye={class:"row1"},ke={class:"sid"},ge={class:"last"},we={class:"meta"},Ce={key:0},Ve={key:1},be={key:0,class:"panel"},Se={class:"hd"},ze={class:"hd-actions"},he={class:"msgs"},$e={class:"bubble"},xe={class:"role"},Me={class:"content"},Ae={class:"time"},Ne={class:"ft"},Te={class:"inline"},Ue={key:1,class:"panel empty"},L=le({__name:"workbench",setup(a){const m=_([]),d=_(""),T=_([]),w=_(""),z=_(!1),C=_(""),$=_(0),x=_(null),Q=re(),M=A(()=>m.value.find(t=>t.session_id===d.value)),W=A(()=>m.value.filter(t=>{var e,f;return!C.value||t.session_id.includes(C.value)||((f=(e=t.last_message)==null?void 0:e.content)==null?void 0:f.includes(C.value))}).sort((t,e)=>+!!e.pinned-+!!t.pinned)),G=A(()=>{var e;const t=(e=M.value)==null?void 0:e.last_message;return t?t.role==="customer"?t.from_customer_id||null:t.to_customer_id||null:null}),V=_(!1),r=_({customer_id:null,amount:0,remark:""});function J(){r.value.customer_id=G.value||null,r.value.amount=0,r.value.remark="",V.value=!0}async function O(){if(!(!r.value.customer_id||!r.value.amount))try{await ce.walletTransfer({customer_id:Number(r.value.customer_id),amount:Number(r.value.amount),remark:r.value.remark}),V.value=!1}catch(t){}}function U(t){Q.push({name:"afterSaleDetail",query:{id:t}})}async function B(){const t=await g.listAgentSessions();m.value=(t.data||[]).map(e=>({...e,pinned:!1})),!d.value&&m.value.length&&(d.value=m.value[0].session_id)}async function b(){if(!d.value)return;const t=await g.getSessionMessages(d.value);T.value=t.data||[],await de(),X(),await g.markSessionRead(d.value)}function X(){const t=document.querySelector(".msgs");t&&(t.scrollTop=t.scrollHeight)}async function I(){if(!(!w.value.trim()||!d.value)){z.value=!0;try{await g.sendMessage(d.value,{content:w.value}),w.value="",await b()}finally{z.value=!1}}}async function Y(){var e;const t=await g.startSession({});d.value=(e=t.data)==null?void 0:e.session_id,await b(),await B()}function Z(t){const e=m.value.find(f=>f.session_id===t);e&&(e.pinned=!e.pinned)}async function h(){var t;try{const e=await g.unreadCount();$.value=((t=e==null?void 0:e.data)==null?void 0:t.unread)||0}catch(e){}}return ne(async()=>{await B(),await b(),await h(),x.value=window.setInterval(()=>{h()},1e4)}),oe(()=>{x.value&&window.clearInterval(x.value)}),(t,e)=>{var q;const f=k("el-input"),v=k("el-button"),ee=k("el-link"),R=k("el-tag"),se=k("el-divider"),te=k("el-input-number"),ae=k("el-dialog");return c(),y("div",pe,[l("aside",ve,[l("div",_e,[n(f,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=s=>C.value=s),placeholder:"搜索会话/消息",size:"small",clearable:""},null,8,["modelValue"]),n(v,{size:"small",type:"primary",onClick:Y},{default:i(()=>[...e[9]||(e[9]=[u("新建会话",-1)])]),_:1})]),e[11]||(e[11]=l("h3",null,"我的会话",-1)),l("ul",null,[(c(!0),y(H,null,K(W.value,s=>{var D;return c(),y("li",{key:s.session_id,class:P({active:s.session_id===d.value}),onClick:F=>{d.value=s.session_id,b()}},[l("div",ye,[l("div",ke,p(s.session_id),1),n(v,{link:"",size:"small",onClick:j(F=>Z(s.session_id),["stop"])},{default:i(()=>[u(p(s.pinned?"取消固定":"固定"),1)]),_:2},1032,["onClick"])]),l("div",ge,p((D=s.last_message)==null?void 0:D.content),1),l("div",we,[s.order_id?(c(),y("span",Ce,"订单#"+p(s.order_id),1)):S("",!0),s.as_id?(c(),y("span",Ve,[e[10]||(e[10]=u(" 售后# ",-1)),n(ee,{type:"primary",underline:!1,onClick:j(F=>U(s.as_id),["stop"])},{default:i(()=>[u(p(s.as_id),1)]),_:2},1032,["onClick"])])):S("",!0),s.unread_count?(c(),N(R,{key:2,type:"danger",size:"small"},{default:i(()=>[u(p(s.unread_count),1)]),_:2},1024)):S("",!0)])],10,fe)}),128))])]),d.value?(c(),y("main",be,[l("header",Se,[l("div",null,[e[12]||(e[12]=l("b",null,"会话：",-1)),u(p(d.value),1)]),l("div",ze,[$.value?(c(),N(R,{key:0,type:"danger",size:"small"},{default:i(()=>[u("未读 "+p($.value),1)]),_:1})):S("",!0),n(v,{size:"small",onClick:h},{default:i(()=>[...e[13]||(e[13]=[u("未读",-1)])]),_:1}),n(v,{size:"small",onClick:b},{default:i(()=>[...e[14]||(e[14]=[u("刷新",-1)])]),_:1}),n(v,{size:"small",onClick:e[1]||(e[1]=()=>ie(g).readAll().then(h))},{default:i(()=>[...e[15]||(e[15]=[u("全部已读",-1)])]),_:1}),n(se,{direction:"vertical"}),n(v,{size:"small",type:"warning",onClick:J},{default:i(()=>[...e[16]||(e[16]=[u("钱包转账",-1)])]),_:1}),(q=M.value)!=null&&q.as_id?(c(),N(v,{key:1,size:"small",type:"primary",onClick:e[2]||(e[2]=s=>U(M.value.as_id))},{default:i(()=>[...e[17]||(e[17]=[u("售后详情",-1)])]),_:1})):S("",!0)])]),l("section",he,[(c(!0),y(H,null,K(T.value,s=>(c(),y("div",{key:s.id,class:P(["msg",s.role])},[l("div",$e,[l("span",xe,p(s.role),1),l("span",Me,p(s.content),1),l("span",Ae,p(s.created_at),1)])],2))),128))]),l("footer",Ne,[n(f,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=s=>w.value=s),disabled:z.value,placeholder:"输入消息，回车发送",onKeyup:ue(I,["enter"])},null,8,["modelValue","disabled"]),n(v,{type:"primary",loading:z.value,onClick:I},{default:i(()=>[...e[18]||(e[18]=[u("发送",-1)])]),_:1},8,["loading"])]),n(ae,{modelValue:V.value,"onUpdate:modelValue":e[8]||(e[8]=s=>V.value=s),title:"钱包转账",width:"420px"},{footer:i(()=>[n(v,{onClick:e[7]||(e[7]=s=>V.value=!1),size:"small"},{default:i(()=>[...e[19]||(e[19]=[u("取消",-1)])]),_:1}),n(v,{type:"primary",size:"small",onClick:O},{default:i(()=>[...e[20]||(e[20]=[u("确认转账",-1)])]),_:1})]),default:i(()=>[l("div",Te,[n(f,{modelValue:r.value.customer_id,"onUpdate:modelValue":e[4]||(e[4]=s=>r.value.customer_id=s),modelModifiers:{number:!0},placeholder:"客户ID",size:"small",style:{width:"140px"}},null,8,["modelValue"]),n(te,{modelValue:r.value.amount,"onUpdate:modelValue":e[5]||(e[5]=s=>r.value.amount=s),min:-999999,max:999999,precision:2,step:10,size:"small"},null,8,["modelValue"]),n(f,{modelValue:r.value.remark,"onUpdate:modelValue":e[6]||(e[6]=s=>r.value.remark=s),placeholder:"备注",size:"small",style:{width:"160px"}},null,8,["modelValue"])])]),_:1},8,["modelValue"])])):(c(),y("main",Ue,"请选择左侧会话"))])}}});typeof E=="function"&&E(L);const Ie=me(L,[["__scopeId","data-v-a9776f49"]]);export{Ie as default};
