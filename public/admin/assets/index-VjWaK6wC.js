
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.hurui.me
 */
    
import{F as u}from"./factory-Cu575xa5.js";import{d as at,r as _,F as v,A as st,V as lt,c as $,e as n,I as q,H as nt,f as a,w as s,i as p,E as U,o as b,t as d,R as ot,S as it,h as r,U as dt,v as rt,x as j}from"./index-CdiJTMf6.js";const ct={class:"p-4 space-y-4"},ut={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},pt={class:"text-28 font-700"},_t={class:"text-28 font-700"},vt={class:"text-28 font-700"},mt={class:"text-28 font-700"},ft={class:"flex items-center justify-between"},ht={class:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"},gt={class:"flex items-center justify-between mb-2"},yt={class:"font-600"},xt={class:"mt-2 text-4 text-gray-500"},wt={class:"mt-2 text-right"},bt={class:"grid grid-cols-1 lg:grid-cols-3 gap-4"},kt={class:"text-4 text-gray-500 mb-2"},zt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},H=at({__name:"index",setup(Tt){const I=_(!1),f=_({status_stats:[],in_production:[],styles:[]}),m=_({daily_capacity:100,work_hours_per_day:12}),h=_([]),y=_([]),k=_([]),Q={planned:"计划中",approved:"已批准",in_production:"生产中",completed:"已完成",shipped:"确认入库",cancelled:"已取消"},M=e=>Q[String(e||"")]||e||"-",N=e=>({planned:"info",approved:"warning",in_production:"primary",completed:"success",shipped:"success",cancelled:"info"})[String(e||"")]||"info",R=async()=>{I.value=!0;try{const e=await u.dashboard();f.value=(e==null?void 0:e.data)||f.value}catch(e){U.error("加载失败")}finally{I.value=!1}},L=async()=>{try{const e=await u.getSettings();e!=null&&e.data&&(m.value={daily_capacity:Number(e.data.daily_capacity||100),work_hours_per_day:Number(e.data.work_hours_per_day||12)})}catch(e){}},S=async()=>{var e;try{const t=await u.list({page:1,size:100,status:"in_production"});h.value=(((e=t==null?void 0:t.data)==null?void 0:e.orders)||[]).sort((l,i)=>new Date(l.expected_finish_at||l.createdAt).getTime()-new Date(i.expected_finish_at||i.createdAt).getTime())}catch(t){h.value=[]}},P=async()=>{var e;try{const t=await u.list({page:1,size:50,status:"approved"});y.value=((e=t==null?void 0:t.data)==null?void 0:e.orders)||[]}catch(t){y.value=[]}},O=async()=>{var e,t;try{const l=await u.list({page:1,size:10,status:"completed"}),i=await u.list({page:1,size:10,status:"shipped"});k.value=[...((e=l==null?void 0:l.data)==null?void 0:e.orders)||[],...((t=i==null?void 0:i.data)==null?void 0:t.orders)||[]].slice(0,10)}catch(l){k.value=[]}},g=e=>{var t;return Number(((t=(f.value.status_stats||[]).find(l=>l.status===e))==null?void 0:t.cnt)||0)},X=v(()=>g("planned")),G=v(()=>g("approved")),J=v(()=>g("in_production")),K=v(()=>g("completed")+g("shipped")),B=_(Date.now());let z=null;const W=e=>{if(!(e!=null&&e.production_started_at)||!(e!=null&&e.expected_finish_at))return 0;const t=new Date(e.production_started_at).getTime(),l=new Date(e.expected_finish_at).getTime(),i=B.value;return l<=t||i<=t?0:i>=l?100:Math.floor((i-t)/(l-t)*100)},E=v(()=>(h.value||[]).reduce((e,t)=>e+(Array.isArray(t.details)?t.details.reduce((l,i)=>l+Number(i.quantity||0),0):0),0)),V=v(()=>{const e=Math.max(1,m.value.work_hours_per_day)/Math.max(1,m.value.daily_capacity);return Math.ceil(E.value*e)}),Y=v(()=>Math.ceil(V.value/Math.max(1,m.value.work_hours_per_day))),T=async(e,t)=>{try{const l={complete:"完成",ship:"确认入库",start:"开工"};await dt.confirm("确定执行 ".concat(l[t]," ?"),"提示",{type:"warning"}),t==="complete"&&await u.complete(e.id),t==="ship"&&await u.ship(e.id),t==="start"&&await u.start(e.id),U.success("操作成功"),F()}catch(l){}},F=async()=>{await Promise.all([R(),S(),P(),O(),L()])};let D=null;return st(async()=>{await F(),D=setInterval(()=>{S(),P()},15e3),z=setInterval(()=>{B.value=Date.now()},1e3)}),lt(()=>{D&&clearInterval(D),z&&clearInterval(z)}),(e,t)=>{const l=p("el-card"),i=p("el-tag"),Z=p("el-progress"),A=p("el-button"),C=p("el-descriptions-item"),tt=p("el-descriptions"),c=p("el-table-column"),x=p("el-table");return b(),$("div",ct,[n("div",ut,[a(l,{shadow:"hover"},{default:s(()=>[t[0]||(t[0]=n("div",{class:"text-12 text-gray-500"},"计划中",-1)),n("div",pt,d(X.value),1)]),_:1}),a(l,{shadow:"hover"},{default:s(()=>[t[1]||(t[1]=n("div",{class:"text-12 text-gray-500"},"已批准",-1)),n("div",_t,d(G.value),1)]),_:1}),a(l,{shadow:"hover"},{default:s(()=>[t[2]||(t[2]=n("div",{class:"text-12 text-gray-500"},"生产中",-1)),n("div",vt,d(J.value),1)]),_:1}),a(l,{shadow:"hover"},{default:s(()=>[t[3]||(t[3]=n("div",{class:"text-12 text-gray-500"},"已完成/入库",-1)),n("div",mt,d(K.value),1)]),_:1})]),h.value.length?(b(),q(l,{key:0,shadow:"never"},{header:s(()=>[n("div",ft,[t[5]||(t[5]=n("div",{class:"font-600"},"进行中订单",-1)),a(i,{type:"warning",size:"small"},{default:s(()=>[...t[4]||(t[4]=[r("每15秒自动刷新",-1)])]),_:1})])]),default:s(()=>[n("div",ht,[(b(!0),$(ot,null,it(h.value,o=>(b(),q(l,{key:o.id,shadow:"hover"},{default:s(()=>[n("div",gt,[n("div",yt,d(o.order_no),1),a(i,{type:N(o.status),size:"small"},{default:s(()=>[r(d(M(o.status)),1)]),_:2},1032,["type"])]),a(Z,{percentage:W(o),"stroke-width":14,status:"success"},null,8,["percentage"]),n("div",xt,[n("span",null,"开始："+d(o.production_started_at||"-"),1),t[6]||(t[6]=n("br",null,null,-1)),n("span",null,"预计："+d(o.expected_finish_at||"-"),1)]),n("div",wt,[a(A,{size:"small",onClick:w=>T(o,"complete")},{default:s(()=>[...t[7]||(t[7]=[r("完成",-1)])]),_:1},8,["onClick"]),a(A,{size:"small",type:"primary",onClick:w=>T(o,"ship")},{default:s(()=>[...t[8]||(t[8]=[r("确认入库",-1)])]),_:1},8,["onClick"])])]),_:2},1024))),128))])]),_:1})):nt("",!0),n("div",bt,[a(l,{shadow:"never"},{header:s(()=>[...t[9]||(t[9]=[r("产能概览",-1)])]),default:s(()=>[n("div",kt,"日产能："+d(m.value.daily_capacity)+" 件；工时/日："+d(m.value.work_hours_per_day)+" 小时",1),a(tt,{column:1,size:"small",border:""},{default:s(()=>[a(C,{label:"当前在制数量"},{default:s(()=>[r(d(E.value),1)]),_:1}),a(C,{label:"预计总工时"},{default:s(()=>[r("约 "+d(V.value)+" 小时（约 "+d(Y.value)+" 天）",1)]),_:1}),a(C,{label:"待开工订单"},{default:s(()=>[r(d(y.value.length),1)]),_:1})]),_:1})]),_:1}),a(l,{shadow:"never"},{header:s(()=>[...t[10]||(t[10]=[r("待开工队列",-1)])]),default:s(()=>[a(x,{data:y.value,size:"small",height:"260","empty-text":"暂无"},{default:s(()=>[a(c,{prop:"order_no",label:"工厂单",width:"140"}),a(c,{label:"明细件数",width:"100",align:"right"},{default:s(({row:o})=>[r(d(Array.isArray(o.details)?o.details.reduce((w,et)=>w+Number(et.quantity||0),0):0),1)]),_:1}),a(c,{label:"操作",width:"140"},{default:s(({row:o})=>[a(A,{size:"small",type:"primary",onClick:w=>T(o,"start")},{default:s(()=>[...t[11]||(t[11]=[r("开工",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),a(l,{shadow:"never"},{header:s(()=>[...t[12]||(t[12]=[r("最近完成/入库",-1)])]),default:s(()=>[a(x,{data:k.value,size:"small",height:"260","empty-text":"暂无"},{default:s(()=>[a(c,{prop:"order_no",label:"工厂单",width:"140"}),a(c,{prop:"status",label:"状态",width:"100"},{default:s(({row:o})=>[a(i,{type:N(o.status),size:"small"},{default:s(()=>[r(d(M(o.status)),1)]),_:2},1032,["type"])]),_:1}),a(c,{prop:"finished_at",label:"完成时间",width:"180"})]),_:1},8,["data"])]),_:1})]),a(l,{shadow:"never"},{header:s(()=>[...t[13]||(t[13]=[r("工厂状态（明细与款式）",-1)])]),default:s(()=>[n("div",zt,[n("div",null,[t[14]||(t[14]=n("h4",null,"生产中（明细Top50）",-1)),a(x,{data:f.value.in_production,size:"small",height:"260"},{default:s(()=>[a(c,{prop:"order_no",label:"工厂单",width:"140"}),a(c,{prop:"product_name",label:"商品"}),a(c,{prop:"size",label:"尺码",width:"80"}),a(c,{prop:"quantity",label:"数量",width:"80",align:"right"})]),_:1},8,["data"])]),n("div",null,[t[15]||(t[15]=n("h4",null,"现有款式",-1)),a(x,{data:f.value.styles,size:"small",height:"260"},{default:s(()=>[a(c,{prop:"id",label:"ID",width:"70"}),a(c,{prop:"name",label:"名称"}),a(c,{prop:"sku_count",label:"尺码数",width:"80",align:"right"})]),_:1},8,["data"])])])]),_:1})])}}});typeof j=="function"&&j(H);const Ct=rt(H,[["__scopeId","data-v-18cb04af"]]);export{Ct as default};
