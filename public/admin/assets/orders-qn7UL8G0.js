
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.hurui.me
 */
    
import{F as f}from"./factory-Cu575xa5.js";import{P as De,a as Le}from"./productExt-B7DASDm9.js";import{d as Me,r as d,F as de,A as qe,V as Be,c as E,f as t,I as T,H as je,w as a,E as V,i,o as y,h as o,e as _,R as Y,S as Z,J as Oe,O as Qe,t as p,U as Re,x as re}from"./index-CdiJTMf6.js";const Xe={class:"p-4"},He={class:"flex items-center justify-between"},Je={class:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"},Ke={class:"flex items-center justify-between mb-2"},Ge={class:"font-600"},We={class:"mt-2 text-xs text-gray-500"},Ye={class:"ml-3"},Ze={class:"mt-2 text-right"},et={key:1},tt={class:"mt-3",style:{"text-align":"right"}},lt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},at={class:"flex items-center gap-2 w-full"},nt={class:"text-right"},ot={class:"mt-2 text-right",style:{"font-size":"12px",color:"#909399"}},st=Me({__name:"orders",setup(it){const Q=d(!1),ee=d([]),te=d(0),N=d(1),R=d(10),X=d(""),H=d(""),P=d(!1),w=d({daily_capacity:100,work_hours_per_day:12}),le=async()=>{var n,e;try{const s=await f.getSettings();if(s!=null&&s.data){const u=s.data;w.value={daily_capacity:(n=u.daily_capacity)!=null?n:w.value.daily_capacity,work_hours_per_day:(e=u.work_hours_per_day)!=null?e:w.value.work_hours_per_day}}}catch(s){}},pe=async()=>{try{await f.saveSettings(w.value),V.success("已保存"),P.value=!1,g()}catch(n){V.error("保存失败")}},ce={planned:"计划中",approved:"已批准",in_production:"生产中",completed:"已完成",shipped:"确认入库",cancelled:"已取消"},me=n=>ce[String(n||"")]||n||"-",ve=n=>({planned:"info",approved:"success",in_production:"warning",completed:"",shipped:"success",cancelled:"info"})[String(n||"")]||"info",_e={manual:"手动",auto_replenish:"自动补货"},fe=n=>_e[String(n||"")]||n||"-",ye=n=>({manual:"info",auto_replenish:"success"})[String(n||"")]||"info",g=async()=>{var n,e,s;Q.value=!0;try{const u=await f.list({page:N.value,size:R.value,status:X.value||void 0,source:H.value||void 0}),c=((n=u==null?void 0:u.data)==null?void 0:n.orders)||[];ee.value=c,te.value=((s=(e=u==null?void 0:u.data)==null?void 0:e.pagination)==null?void 0:s.total)||c.length}catch(u){V.error("加载失败")}finally{Q.value=!1}},D=d([]),I=async()=>{var n;try{const e=await f.list({page:1,size:100,status:"in_production"});D.value=((n=e==null?void 0:e.data)==null?void 0:n.orders)||[]}catch(e){D.value=[]}};let J=null;const ae=d(Date.now());let K=null;const ge=()=>{L.value=!1,M.value="",b.value=[],x.value=null,F.value=[],h.value=null,z.value=1,S.value=0,be(),$.value=!0},be=async()=>{var n;try{const e=await De.getProductList({page:1,limit:200,status:"active"});G.value=((n=e==null?void 0:e.data)==null?void 0:n.products)||[]}catch(e){G.value=[]}},xe=async n=>{x.value=n,h.value=null,z.value=1,S.value=Number(n.purchase_price||0);try{const e=await Le.listSkus(String(n.id));F.value=(e==null?void 0:e.data)||[]}catch(e){F.value=[]}},we=()=>{if(!x.value)return;const n=F.value.find(c=>String(c.id)===String(h.value)),e=(n==null?void 0:n.size)||void 0,s=S.value||Number(x.value.purchase_price||0)||0,u={product_id:x.value.id,product_name:x.value.name,sku_id:n==null?void 0:n.id,size:e,quantity:z.value||1,unit_cost:s};b.value.push(u),h.value=null,z.value=1,S.value=Number(x.value.purchase_price||0)},ke=n=>{b.value.splice(n,1)},Ve=de(()=>b.value.reduce((n,e)=>n+Number(e.quantity||0),0)),Ce=de(()=>b.value.reduce((n,e)=>n+Number(e.unit_cost||0)*Number(e.quantity||0),0)),C=n=>{if(!n.production_started_at||!n.expected_finish_at)return 0;const e=new Date(n.production_started_at).getTime(),s=new Date(n.expected_finish_at).getTime(),u=ae.value;return s<=e||u<=e?0:u>=s?100:Math.floor((u-e)/(s-e)*100)},k=async(n,e)=>{try{const s={approve:"批准",start:"开工",complete:"完成",ship:"确认入库",cancel:"取消"};await Re.confirm("确定执行 ".concat(s[e]," ?"),"提示",{type:"warning"}),e==="approve"&&await f.approve(n.id),e==="start"&&await f.start(n.id),e==="complete"&&await f.complete(n.id),e==="ship"&&await f.ship(n.id),e==="cancel"&&await f.cancel(n.id),V.success("操作成功"),g(),le(),I()}catch(s){}},ne=async(n,e)=>{try{await f.move(n.id,e),g()}catch(s){V.error("调整失败")}},$=d(!1),L=d(!1),M=d(""),b=d([]),G=d([]),x=d(null),F=d([]),h=d(null),z=d(1),S=d(0),he=async()=>{try{if(!b.value.length)return V.warning("请先添加商品与尺码");const n={expedite:L.value,remark:M.value,items:b.value},e=await f.create(n);(e==null?void 0:e.success)!==!1&&(V.success("创建成功"),$.value=!1,g(),I())}catch(n){V.error("创建失败")}},oe=n=>{const e="/api/factory/orders/".concat(n.id,"/print-inbound");window.open(e,"_blank")},ze=n=>n.status==="planned"?"批准":n.status==="approved"?"开工":n.status==="in_production"?C(n)>=100?"确认入库":"完成":n.status==="completed"?"确认入库":"查看",Se=async n=>{const e=n.status;if(e==="planned")return k(n,"approve");if(e==="approved")return k(n,"start");if(e==="in_production")return C(n)>=100?k(n,"ship"):k(n,"complete");if(e==="completed")return k(n,"ship")};return qe(()=>{le(),g(),I(),J=setInterval(I,15e3),K=setInterval(()=>{ae.value=Date.now()},1e3)}),Be(()=>{J&&clearInterval(J),K&&clearInterval(K)}),(n,e)=>{const s=i("el-option"),u=i("el-select"),c=i("el-form-item"),m=i("el-button"),q=i("el-form"),U=i("el-card"),A=i("el-tag"),se=i("el-progress"),B=i("el-descriptions-item"),Ue=i("el-descriptions"),r=i("el-table-column"),W=i("el-table"),j=i("el-dropdown-item"),Te=i("el-dropdown-menu"),Ne=i("el-dropdown"),Pe=i("el-pagination"),O=i("el-input-number"),ie=i("el-dialog"),Ie=i("el-switch"),$e=i("el-input"),Fe=i("el-alert"),Ae=i("el-divider"),Ee=Qe("loading");return y(),E("div",Xe,[t(U,{class:"mb-4"},{header:a(()=>[...e[19]||(e[19]=[o("筛选",-1)])]),default:a(()=>[t(q,{inline:""},{default:a(()=>[t(c,{label:"状态"},{default:a(()=>[t(u,{modelValue:X.value,"onUpdate:modelValue":e[0]||(e[0]=l=>X.value=l),clearable:"",style:{width:"160px"},onChange:e[1]||(e[1]=()=>{N.value=1,g()})},{default:a(()=>[t(s,{label:"全部",value:""}),t(s,{label:"计划中",value:"planned"}),t(s,{label:"已批准",value:"approved"}),t(s,{label:"生产中",value:"in_production"}),t(s,{label:"已完成",value:"completed"}),t(s,{label:"确认入库",value:"shipped"}),t(s,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"来源"},{default:a(()=>[t(u,{modelValue:H.value,"onUpdate:modelValue":e[2]||(e[2]=l=>H.value=l),clearable:"",style:{width:"160px"},onChange:e[3]||(e[3]=()=>{N.value=1,g()})},{default:a(()=>[t(s,{label:"全部",value:""}),t(s,{label:"手动",value:"manual"}),t(s,{label:"自动补货",value:"auto_replenish"})]),_:1},8,["modelValue"])]),_:1}),t(m,{type:"primary",onClick:ge},{default:a(()=>[...e[20]||(e[20]=[o("新建工厂订单",-1)])]),_:1}),t(m,{onClick:e[4]||(e[4]=()=>P.value=!0)},{default:a(()=>[...e[21]||(e[21]=[o("工厂设置",-1)])]),_:1}),t(m,{text:"",type:"primary",onClick:I},{default:a(()=>[...e[22]||(e[22]=[o("刷新进行中",-1)])]),_:1})]),_:1})]),_:1}),D.value.length?(y(),T(U,{key:0,class:"mb-4"},{header:a(()=>[_("div",He,[e[24]||(e[24]=_("span",null,"进行中订单",-1)),t(A,{type:"warning",size:"small"},{default:a(()=>[...e[23]||(e[23]=[o("自动每15秒刷新",-1)])]),_:1})])]),default:a(()=>[_("div",Je,[(y(!0),E(Y,null,Z(D.value,l=>(y(),T(U,{key:l.id,shadow:"hover"},{default:a(()=>[_("div",Ke,[_("div",Ge,p(l.order_no),1),t(A,{type:C(l)>=100?"success":"warning",size:"small"},{default:a(()=>[o(p(C(l)>=100?"生产完毕，待确认":"生产中"),1)]),_:2},1032,["type"])]),t(se,{percentage:C(l),"stroke-width":10,status:"success"},null,8,["percentage"]),_("div",We,[_("span",null,"开始："+p(l.production_started_at||"-"),1),_("span",Ye,"预计完成："+p(l.expected_finish_at||"-"),1)]),_("div",Ze,[t(m,{size:"small",onClick:v=>k(l,"complete")},{default:a(()=>[...e[25]||(e[25]=[o("完成",-1)])]),_:1},8,["onClick"]),t(m,{size:"small",type:"primary",onClick:v=>k(l,"ship")},{default:a(()=>[...e[26]||(e[26]=[o("确认入库",-1)])]),_:1},8,["onClick"]),t(m,{size:"small",text:"",onClick:v=>oe(l)},{default:a(()=>[...e[27]||(e[27]=[o("打印入库单",-1)])]),_:1},8,["onClick"])])]),_:2},1024))),128))])]),_:1})):je("",!0),t(U,null,{default:a(()=>[Oe((y(),T(W,{data:ee.value,stripe:""},{default:a(()=>[t(r,{type:"expand"},{default:a(({row:l})=>[t(Ue,{column:2,size:"small",border:""},{default:a(()=>[t(B,{label:"生产开始"},{default:a(()=>[o(p(l.production_started_at||"-"),1)]),_:2},1024),t(B,{label:"预计完成"},{default:a(()=>[o(p(l.expected_finish_at||"-"),1)]),_:2},1024),t(B,{label:"实际完成"},{default:a(()=>[o(p(l.finished_at||"-"),1)]),_:2},1024),t(B,{label:"当前进度"},{default:a(()=>[t(se,{percentage:C(l),style:{width:"220px"}},null,8,["percentage"])]),_:2},1024)]),_:2},1024),t(W,{data:l.details||[],size:"small",class:"mt-2"},{default:a(()=>[t(r,{label:"商品",prop:"product.name","min-width":"160"},{default:a(({row:v})=>{var ue;return[o(p(((ue=v.product)==null?void 0:ue.name)||"-"),1)]}),_:1}),t(r,{label:"尺码",prop:"size",width:"90"}),t(r,{label:"数量",prop:"quantity",width:"90",align:"center"}),t(r,{label:"单价",width:"110",align:"right"},{default:a(({row:v})=>[o("¥"+p(Number(v.unit_cost||0).toFixed(2)),1)]),_:1}),t(r,{label:"小计",width:"120",align:"right"},{default:a(({row:v})=>[o("¥"+p(Number(v.subtotal_cost||0).toFixed(2)),1)]),_:1})]),_:1},8,["data"])]),_:1}),t(r,{prop:"order_no",label:"工厂单号",width:"160"}),t(r,{prop:"status",label:"状态",width:"110"},{default:a(({row:l})=>[t(A,{type:ve(l.status),size:"small"},{default:a(()=>[o(p(me(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(r,{prop:"source",label:"来源",width:"110"},{default:a(({row:l})=>[t(A,{type:ye(l.source),size:"small"},{default:a(()=>[o(p(fe(l.source)),1)]),_:2},1032,["type"])]),_:1}),t(r,{label:"加急",width:"80"},{default:a(({row:l})=>[l.expedite?(y(),T(A,{key:0,type:"danger",size:"small"},{default:a(()=>[...e[28]||(e[28]=[o("加急",-1)])]),_:1})):(y(),E("span",et,"-"))]),_:1}),t(r,{prop:"total_cost",label:"合计成本",width:"120",align:"right"},{default:a(({row:l})=>[o("¥"+p(Number(l.total_cost||0).toFixed(2)),1)]),_:1}),t(r,{prop:"createdAt",label:"创建时间",width:"180"}),t(r,{label:"操作",width:"360",fixed:"right"},{default:a(({row:l})=>[t(m,{size:"small",type:"primary",onClick:v=>Se(l)},{default:a(()=>[o(p(ze(l)),1)]),_:2},1032,["onClick"]),t(Ne,null,{dropdown:a(()=>[t(Te,null,{default:a(()=>[t(j,{onClick:v=>oe(l)},{default:a(()=>[...e[30]||(e[30]=[o("打印入库单",-1)])]),_:1},8,["onClick"]),t(j,{disabled:!(l.status==="approved"&&!l.expedite),onClick:v=>ne(l,"up")},{default:a(()=>[...e[31]||(e[31]=[o("上移",-1)])]),_:1},8,["disabled","onClick"]),t(j,{disabled:!(l.status==="approved"&&!l.expedite),onClick:v=>ne(l,"down")},{default:a(()=>[...e[32]||(e[32]=[o("下移",-1)])]),_:1},8,["disabled","onClick"]),t(j,{divided:"",type:"danger",disabled:["shipped","cancelled"].includes(l.status),onClick:v=>k(l,"cancel")},{default:a(()=>[...e[33]||(e[33]=[o("取消订单",-1)])]),_:1},8,["disabled","onClick"])]),_:2},1024)]),default:a(()=>[t(m,{size:"small",text:""},{default:a(()=>[...e[29]||(e[29]=[o("更多",-1)])]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ee,Q.value]]),_("div",tt,[t(Pe,{"current-page":N.value,"onUpdate:currentPage":e[5]||(e[5]=l=>N.value=l),"page-size":R.value,"onUpdate:pageSize":e[6]||(e[6]=l=>R.value=l),total:te.value,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:g,onSizeChange:g},null,8,["current-page","page-size","total"])])]),_:1}),t(ie,{modelValue:P.value,"onUpdate:modelValue":e[10]||(e[10]=l=>P.value=l),title:"工厂设置",width:"520px"},{footer:a(()=>[t(m,{onClick:e[9]||(e[9]=l=>P.value=!1)},{default:a(()=>[...e[34]||(e[34]=[o("取消",-1)])]),_:1}),t(m,{type:"primary",onClick:pe},{default:a(()=>[...e[35]||(e[35]=[o("保存",-1)])]),_:1})]),default:a(()=>[t(q,{"label-width":"140px"},{default:a(()=>[t(c,{label:"日产能（件）"},{default:a(()=>[t(O,{modelValue:w.value.daily_capacity,"onUpdate:modelValue":e[7]||(e[7]=l=>w.value.daily_capacity=l),min:1,step:10},null,8,["modelValue"])]),_:1}),t(c,{label:"工时/日（小时）"},{default:a(()=>[t(O,{modelValue:w.value.work_hours_per_day,"onUpdate:modelValue":e[8]||(e[8]=l=>w.value.work_hours_per_day=l),min:1,max:24},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(ie,{modelValue:$.value,"onUpdate:modelValue":e[18]||(e[18]=l=>$.value=l),title:"新建工厂订单",width:"820px"},{footer:a(()=>[t(m,{onClick:e[17]||(e[17]=l=>$.value=!1)},{default:a(()=>[...e[40]||(e[40]=[o("取消",-1)])]),_:1}),t(m,{type:"primary",disabled:!b.value.length,onClick:he},{default:a(()=>[...e[41]||(e[41]=[o("创建",-1)])]),_:1},8,["disabled"])]),default:a(()=>[_("div",lt,[t(U,{shadow:"never"},{header:a(()=>[...e[36]||(e[36]=[o("选择商品与尺码",-1)])]),default:a(()=>[t(q,{"label-width":"90px"},{default:a(()=>[t(c,{label:"商品"},{default:a(()=>[t(u,{modelValue:x.value,"onUpdate:modelValue":e[11]||(e[11]=l=>x.value=l),"value-key":"id",filterable:"",style:{width:"100%"},placeholder:"选择商品",onChange:xe},{default:a(()=>[(y(!0),E(Y,null,Z(G.value,l=>(y(),T(s,{key:l.id,label:l.name,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"尺码SKU"},{default:a(()=>[_("div",at,[t(u,{modelValue:h.value,"onUpdate:modelValue":e[12]||(e[12]=l=>h.value=l),filterable:"",style:{flex:"1"},placeholder:"选择尺码"},{default:a(()=>[(y(!0),E(Y,null,Z(F.value,l=>(y(),T(s,{key:l.id,label:l.size,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(O,{modelValue:z.value,"onUpdate:modelValue":e[13]||(e[13]=l=>z.value=l),min:1},null,8,["modelValue"])])]),_:1}),t(c,{label:"单价(元)"},{default:a(()=>[t(O,{modelValue:S.value,"onUpdate:modelValue":e[14]||(e[14]=l=>S.value=l),precision:2,step:.5,min:0},null,8,["modelValue"])]),_:1}),_("div",nt,[t(m,{onClick:we,type:"primary",plain:""},{default:a(()=>[...e[37]||(e[37]=[o("加入明细",-1)])]),_:1})])]),_:1})]),_:1}),t(U,{shadow:"never"},{header:a(()=>[...e[38]||(e[38]=[o("订单参数",-1)])]),default:a(()=>[t(q,{"label-width":"100px"},{default:a(()=>[t(c,{label:"加急"},{default:a(()=>[t(Ie,{modelValue:L.value,"onUpdate:modelValue":e[15]||(e[15]=l=>L.value=l)},null,8,["modelValue"])]),_:1}),t(c,{label:"备注"},{default:a(()=>[t($e,{modelValue:M.value,"onUpdate:modelValue":e[16]||(e[16]=l=>M.value=l),placeholder:"可填写生产要求、备忘等",type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),t(Fe,{title:"说明：运费已取消（工厂在仓边）。生产完成后系统会自动入库，或在订单完成后点击【确认入库】。",type:"info","show-icon":""})]),_:1}),_("div",ot," 共 "+p(Ve.value)+" 件，预估金额 ¥"+p(Number(Ce.value||0).toFixed(2)),1)]),_:1})]),t(Ae),t(W,{data:b.value,size:"small",height:"260","empty-text":"请在左侧选择商品与尺码后加入明细"},{default:a(()=>[t(r,{label:"#",type:"index",width:"50"}),t(r,{label:"商品",prop:"product_name","min-width":"160"}),t(r,{label:"尺码",prop:"size",width:"100"}),t(r,{label:"数量",prop:"quantity",width:"100",align:"center"}),t(r,{label:"单价(元)",width:"120",align:"right"},{default:a(({row:l})=>[o(p(Number(l.unit_cost||0).toFixed(2)),1)]),_:1}),t(r,{label:"操作",width:"100"},{default:a(({$index:l})=>[t(m,{size:"small",type:"danger",text:"",onClick:v=>ke(l)},{default:a(()=>[...e[39]||(e[39]=[o("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}}});typeof re=="function"&&re(st);export{st as default};
