import{d as Y,r as p,l as Z,m as R,o as ee,p as te,q as le,a as N,c as B,b as r,e as l,w as a,f as n,h as v,F as ae,g as oe,k as c,t as i,n as se,E as f,i as ne,j as D,s as de,_ as ue}from"./index-DaL8kBdz.js";const ie={class:"checkout"},re={style:{"margin-top":"10px"}},ce={class:"item"},me=["src"],pe={class:"name"},ve={class:"spec"},fe={class:"pay-tools"},_e={class:"balance"},be={key:0,class:"tip"},ye={class:"total"},we={class:"recharge"},ge=Y({__name:"Checkout",setup(Ve){const J=ne(),q=p(!1),h=p([]),g=p(null),U=p(!1),s=p({receiver_name:"",phone:"",province:"",city:"",district:"",detail:"",is_default:!1}),z=p(!0),M=Z(),V=p([]),F=R(()=>V.value.reduce((o,e)=>o+Number(e.amount||0),0)),W=R(()=>F.value.toFixed(2));function j(){try{const o=localStorage.getItem("token")||"",e=JSON.parse(decodeURIComponent(escape(window.atob(o.split(".")[1]))));return Number(e?.id||e?.user_id||null)||null}catch{return null}}async function I(){q.value=!0;try{const o=await v.get("/api/addresses");if(o.data?.success){h.value=o.data.data||[];const u=h.value.find(_=>_.is_default);g.value=u?.id||h.value[0]?.id||null}const e=[];for(const u of M.items){const{data:_}=await v.get(`/api/catalog/sku/${u.sku_id}`);if(_?.success){const{sku:d,product:b}=_.data,m=b?.media?.find?.(C=>C.is_main)?.url||b?.image_url||"https://via.placeholder.com/120x120?text=SKU",x=u.quantity;e.push({sku_id:d.id,product_id:d.product_id,name:b?.name||"",size:d.size,color:d.color,barcode:d.barcode,image:m,price:Number(d.retail_price||0),quantity:x,amount:+(Number(d.retail_price||0)*Number(x)).toFixed(2)})}}V.value=e}finally{q.value=!1}}async function K(o){const{data:e}=await v.post(`/api/addresses/${o}/default`);e?.success&&(f.success("已设为默认"),await I())}async function L(){const{data:o}=await v.post("/api/addresses",s.value);o?.success&&(f.success("已保存"),U.value=!1,I())}const $=p({balance:0,transactions:[]}),k=p(null);async function S(){try{const{data:o}=await v.get("/api/wallet/me");o?.success&&($.value={balance:Number(o.data?.balance||0),transactions:o.data?.transactions||[]})}catch{}}async function O(){if(!k.value||k.value<=0)return f.warning("请输入正确金额");const{data:o}=await v.post("/api/wallet/recharge",{amount:k.value});o?.success&&(f.success("充值成功"),await S(),k.value=null)}ee(async()=>{await I(),await S()});async function T(){if(!g.value)return f.warning("请选择地址");if(!V.value.length)return f.warning("购物车为空");const o={items:V.value.map(u=>({sku_id:u.sku_id,quantity:u.quantity})),address_id:g.value},{data:e}=await v.post("/api/orders/checkout",o);if(e?.success){f.success("订单已创建，准备支付...");const u=e.data.order_id,_=Number(e.data?.pay_amount??F.value);let d=!1;const b=j();if(z.value&&$.value.balance>=_&&b)try{(await v.post(`/api/orders/${u}/pay`,{customer_id:b})).data?.success&&(d=!0)}catch{}d||(await v.post(`/api/orders/${u}/pay`)).data?.success&&(d=!0),await S(),d?(f.success("支付成功"),M.clear(),J.push("/orders")):f.error("支付失败，请稍后重试")}}return(o,e)=>{const u=n("el-tag"),_=n("el-link"),d=n("el-radio"),b=n("el-radio-group"),m=n("el-button"),x=n("el-card"),C=n("el-table-column"),G=n("el-table"),A=n("el-col"),E=n("el-switch"),y=n("el-input"),H=n("el-row"),w=n("el-form-item"),P=n("el-form"),Q=n("el-dialog"),X=le("loading");return te((N(),B("div",ie,[e[23]||(e[23]=r("h2",null,"结算",-1)),l(H,{gutter:20},{default:a(()=>[l(A,{md:16,sm:24},{default:a(()=>[l(x,{shadow:"never",class:"addresses"},{header:a(()=>[...e[13]||(e[13]=[c("收货地址",-1)])]),default:a(()=>[l(b,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=t=>g.value=t)},{default:a(()=>[(N(!0),B(ae,null,oe(h.value,t=>(N(),D(d,{key:t.id,label:t.id},{default:a(()=>[c(i(t.receiver_name)+" / "+i(t.phone)+" / "+i(t.province)+i(t.city)+i(t.district)+" "+i(t.detail)+" ",1),t.is_default?(N(),D(u,{key:0,size:"small",type:"success",style:{"margin-left":"8px"}},{default:a(()=>[...e[14]||(e[14]=[c("默认",-1)])]),_:1})):(N(),D(_,{key:1,type:"primary",underline:!1,style:{"margin-left":"8px"},onClick:de(ke=>K(t.id),["stop"])},{default:a(()=>[...e[15]||(e[15]=[c("设为默认",-1)])]),_:1},8,["onClick"]))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]),r("div",re,[l(m,{size:"small",onClick:e[1]||(e[1]=t=>U.value=!0)},{default:a(()=>[...e[16]||(e[16]=[c("新增地址",-1)])]),_:1})])]),_:1}),l(x,{shadow:"never",style:{"margin-top":"16px"}},{header:a(()=>[...e[17]||(e[17]=[c("订单明细",-1)])]),default:a(()=>[l(G,{data:V.value,border:"",size:"small"},{default:a(()=>[l(C,{label:"商品","min-width":"260"},{default:a(({row:t})=>[r("div",ce,[r("img",{src:t.image},null,8,me),r("div",null,[r("div",pe,i(t.name),1),r("div",ve,i(t.size)+" / "+i(t.color)+" （条码："+i(t.barcode)+"）",1)])])]),_:1}),l(C,{prop:"price",label:"单价",width:"120"}),l(C,{prop:"quantity",label:"数量",width:"100"}),l(C,{prop:"amount",label:"小计",width:"120"})]),_:1},8,["data"])]),_:1})]),_:1}),l(A,{md:8,sm:24},{default:a(()=>[l(x,{shadow:"never"},{header:a(()=>[...e[18]||(e[18]=[c("支付",-1)])]),default:a(()=>[r("div",fe,[l(E,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=t=>z.value=t),"active-text":"使用钱包支付","inactive-text":"常规支付"},null,8,["modelValue"]),r("div",_e,"钱包余额：¥"+i($.value.balance.toFixed(2)),1),z.value&&$.value.balance<F.value?(N(),B("div",be,"余额不足，将使用常规支付")):se("",!0)]),r("div",ye,"合计：¥"+i(W.value),1),r("div",we,[l(y,{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=t=>k.value=t),modelModifiers:{number:!0},type:"number",placeholder:"充值金额",style:{width:"140px"}},null,8,["modelValue"]),l(m,{size:"small",onClick:O},{default:a(()=>[...e[19]||(e[19]=[c("充值",-1)])]),_:1})]),l(m,{type:"primary",disabled:!g.value||!V.value.length,onClick:T},{default:a(()=>[...e[20]||(e[20]=[c("提交订单",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),l(Q,{modelValue:U.value,"onUpdate:modelValue":e[12]||(e[12]=t=>U.value=t),title:"新增收货地址",width:"520px"},{footer:a(()=>[l(m,{onClick:e[11]||(e[11]=t=>U.value=!1)},{default:a(()=>[...e[21]||(e[21]=[c("取消",-1)])]),_:1}),l(m,{type:"primary",onClick:L},{default:a(()=>[...e[22]||(e[22]=[c("保存",-1)])]),_:1})]),default:a(()=>[l(P,{model:s.value,"label-width":"90px"},{default:a(()=>[l(w,{label:"收货人"},{default:a(()=>[l(y,{modelValue:s.value.receiver_name,"onUpdate:modelValue":e[4]||(e[4]=t=>s.value.receiver_name=t)},null,8,["modelValue"])]),_:1}),l(w,{label:"电话"},{default:a(()=>[l(y,{modelValue:s.value.phone,"onUpdate:modelValue":e[5]||(e[5]=t=>s.value.phone=t)},null,8,["modelValue"])]),_:1}),l(w,{label:"省"},{default:a(()=>[l(y,{modelValue:s.value.province,"onUpdate:modelValue":e[6]||(e[6]=t=>s.value.province=t)},null,8,["modelValue"])]),_:1}),l(w,{label:"市"},{default:a(()=>[l(y,{modelValue:s.value.city,"onUpdate:modelValue":e[7]||(e[7]=t=>s.value.city=t)},null,8,["modelValue"])]),_:1}),l(w,{label:"区/县"},{default:a(()=>[l(y,{modelValue:s.value.district,"onUpdate:modelValue":e[8]||(e[8]=t=>s.value.district=t)},null,8,["modelValue"])]),_:1}),l(w,{label:"详细地址"},{default:a(()=>[l(y,{modelValue:s.value.detail,"onUpdate:modelValue":e[9]||(e[9]=t=>s.value.detail=t)},null,8,["modelValue"])]),_:1}),l(w,{label:"设为默认"},{default:a(()=>[l(E,{modelValue:s.value.is_default,"onUpdate:modelValue":e[10]||(e[10]=t=>s.value.is_default=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])),[[X,q.value]])}}}),Ce=ue(ge,[["__scopeId","data-v-f2037fdb"]]);export{Ce as default};
