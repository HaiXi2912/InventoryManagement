
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.hurui.me
 */
    
import{S as T,i as X}from"./statistics-BeMh-WQJ.js";import{d as xe,r as g,C as me,x as Se,G as Me,O as $e,c as Ye,a as l,f as a,w as o,m as pe,E as ve,i as h,o as Te,h as O,t as H,p as ke,q as _e}from"./index-BOHDOdY5.js";const Ne={class:"statistics-reports"},Re={class:"toolbar-section"},Ve={class:"toolbar"},Fe={class:"toolbar-left"},ze={class:"toolbar-right"},Pe={class:"overview-section"},Ae={class:"overview-content"},Le={class:"overview-info"},Oe={class:"overview-value"},Ee={class:"overview-content"},Be={class:"overview-info"},Ue={class:"overview-value"},qe={class:"overview-content"},Ie={class:"overview-info"},Ce={class:"overview-value"},He={class:"overview-content"},Je={class:"overview-info"},We={class:"overview-value"},je={class:"charts-section"},Ge={class:"card-header"},Ke={style:{float:"right",display:"flex",gap:"8px","align-items":"center"}},Xe={class:"size-charts-section"},fe=xe({__name:"reports",setup(Ze){const Z=g(!1),U=g([new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString().split("T")[0],new Date().toISOString().split("T")[0]]),k=g("day"),b=g("none"),Q=g([]),ee=g([]),q=g({gmv:0,netSales:0,orders:0,items:0,refund:0,grossProfit:0}),I=g([]),J=g([]),ne=g([]),W=g("amount"),j=g([]),re=g([]),te=g(),ae=g(),oe=g(),se=g();let F,z,P,A;const ge=(c,e,t)=>{const u=new Date(c),m=new Date(e);u.setHours(0,0,0,0),m.setHours(0,0,0,0);const r=[],p=n=>String(n).padStart(2,"0");if(t==="day")for(let n=new Date(u);n<=m;n.setDate(n.getDate()+1))r.push("".concat(n.getFullYear(),"-").concat(p(n.getMonth()+1),"-").concat(p(n.getDate())));else if(t==="week"){const n=new Date(u),L=n.getDay()||7;for(n.setDate(n.getDate()-L+1);n<=m;){const N=new Date(n.getFullYear(),0,1),_=Math.ceil(((n.getTime()-N.getTime())/864e5+N.getDay()+1)/7);r.push("".concat(n.getFullYear(),"-W").concat(p(_))),n.setDate(n.getDate()+7)}}else{const n=new Date(u);for(n.setDate(1);n<=m;)r.push("".concat(n.getFullYear(),"-").concat(p(n.getMonth()+1))),n.setMonth(n.getMonth()+1)}return r};function ue(c,e){const t=new Date(c);return t.setDate(t.getDate()+e),t}function de(c){const e=t=>String(t).padStart(2,"0");return"".concat(c.getFullYear(),"-").concat(e(c.getMonth()+1),"-").concat(e(c.getDate()))}const ye=async(c,e)=>{if(Q.value=[],ee.value=[],b.value==="none")return;const t=new Date(c),u=new Date(e);t.setHours(0,0,0,0),u.setHours(0,0,0,0);let m,r;if(b.value==="yoy")m=new Date(t),r=new Date(u),m.setFullYear(m.getFullYear()-1),r.setFullYear(r.getFullYear()-1);else{const d=Math.round((u.getTime()-t.getTime())/864e5)+1;r=ue(t,-1),m=ue(r,-(d-1))}const p=de(m),n=de(r),[L,N]=await Promise.all([T.getSalesTrend({start_date:p,end_date:n}),T.getPurchaseTrend({start_date:p,end_date:n})]),_=(d,v)=>{const $=new Map;return d.forEach(s=>{const i=new Date(s.date),f=D=>String(D).padStart(2,"0");let V="".concat(i.getFullYear(),"-").concat(f(i.getMonth()+1),"-").concat(f(i.getDate()));if(v==="month"&&(V="".concat(i.getFullYear(),"-").concat(f(i.getMonth()+1))),v==="week"){const D=new Date(i),B=D.getDay()||7;D.setDate(D.getDate()-B+1);const C=new Date(D.getFullYear(),0,1),S=Math.ceil(((D.getTime()-C.getTime())/864e5+C.getDay()+1)/7);V="".concat(D.getFullYear(),"-W").concat(f(S))}const Y=$.get(V)||{amount:0,count:0};$.set(V,{amount:Y.amount+Number(s.amount||0),count:Y.count+Number(s.count||0)})}),$},y=I.value.map(d=>d.key),x=_(L.data||[],k.value),M=_(N.data||[],k.value),R=[],E=[];y.forEach((d,v)=>{x.get(d),M.get(d)});const w=Array.from(x.entries()).sort((d,v)=>d[0].localeCompare(v[0])).map(([d,v])=>({key:d,amount:v.amount,count:v.count})),K=Array.from(M.entries()).sort((d,v)=>d[0].localeCompare(v[0])).map(([d,v])=>({key:d,amount:v.amount,count:v.count}));y.forEach((d,v)=>{const $=x.get(d)||w[v]||{amount:0,count:0},s=M.get(d)||K[v]||{amount:0,count:0};R.push({key:d,amount:$.amount||0,count:$.count||0}),E.push({key:d,amount:s.amount||0,count:s.count||0})}),Q.value=R,ee.value=E},le=async()=>{var c,e;Z.value=!0;try{const[t,u]=U.value,m=await Promise.allSettled([T.getOverview({start_date:t,end_date:u}),T.getSalesTrend({start_date:t,end_date:u}),T.getPurchaseTrend({start_date:t,end_date:u}),T.getSalesByCategory({start_date:t,end_date:u}),T.getTop({start_date:t,end_date:u,limit:10}),T.getSalesBySize({start_date:t,end_date:u})]),r=(s,i)=>{const f=m[s];return f&&f.status==="fulfilled"?f.value:i},p=r(0,{data:{sale_stats:[],purchase_stats:[]}}),n=r(1,{data:[]}),L=r(2,{data:[]}),N=r(3,{data:[]}),_=r(4,{data:[]}),y=r(5,{data:[]}),x=((c=p.data)==null?void 0:c.sale_stats)||[],M=((e=p.data)==null?void 0:e.purchase_stats)||[],R=x.reduce((s,i)=>s+Number(i.total_amount||0),0),E=x.reduce((s,i)=>s+Number(i.count||0),0),w=M.reduce((s,i)=>s+Number(i.total_amount||0),0);q.value={gmv:R,netSales:R,orders:E,items:0,refund:0,grossProfit:R-w};const K=(s,i)=>{const f=new Map;return s.forEach(V=>{const Y=new Date(V.date),D=S=>String(S).padStart(2,"0");let B="".concat(Y.getFullYear(),"-").concat(D(Y.getMonth()+1),"-").concat(D(Y.getDate()));if(i==="month"&&(B="".concat(Y.getFullYear(),"-").concat(D(Y.getMonth()+1))),i==="week"){const S=new Date(Y),De=S.getDay()||7;S.setDate(S.getDate()-De+1);const ce=new Date(S.getFullYear(),0,1),he=Math.ceil(((S.getTime()-ce.getTime())/864e5+ce.getDay()+1)/7);B="".concat(S.getFullYear(),"-W").concat(D(he))}const C=f.get(B)||{amount:0,count:0};f.set(B,{amount:C.amount+Number(V.amount||0),count:C.count+Number(V.count||0)})}),f},d=ge(t,u,k.value),v=K(n.data||[],k.value),$=K(L.data||[],k.value);I.value=d.map(s=>{var i,f;return{key:s,amount:Number(((i=v.get(s))==null?void 0:i.amount)||0),count:Number(((f=v.get(s))==null?void 0:f.count)||0)}}),J.value=d.map(s=>{var i,f;return{key:s,amount:Number(((i=$.get(s))==null?void 0:i.amount)||0),count:Number(((f=$.get(s))==null?void 0:f.count)||0)}}),ne.value=(N.data||[]).map(s=>({category:s.category,sales:Number(s.sales||0),profit:Number(s.profit||0),percentage:Number(s.percentage||0)})),j.value=(_.data||[]).map(s=>({name:s.productName,amount:Number(s.sales||0),qty:Number(s.quantity||0)})),re.value=(y.data||[]).map(s=>({size:s.size,qty:Number(s.qty||0),sales:Number(s.sales||0)})),await ye(t,u),await pe(),ie()}catch(t){ve.error((t==null?void 0:t.message)||"加载统计失败"),await pe(),ie()}finally{Z.value=!1}},we=()=>{te.value&&(F=X(te.value)),ae.value&&(z=X(ae.value)),oe.value&&(P=X(oe.value)),se.value&&(A=X(se.value))},ie=()=>{F==null||F.setOption({title:{text:"销售趋势",left:"center"},tooltip:{trigger:"axis"},legend:{top:30,data:["销售额","订单数",b.value==="yoy"?"销售额-同比":b.value==="mom"?"销售额-环比":null].filter(Boolean)},dataZoom:[{type:"inside"},{type:"slider"}],xAxis:{type:"category",data:I.value.map(t=>t.key)},yAxis:[{type:"value",name:"金额(元)"},{type:"value",name:"订单数"}],series:[{name:"销售额",type:"line",smooth:!0,data:I.value.map(t=>t.amount)},{name:"订单数",type:"bar",yAxisIndex:1,data:I.value.map(t=>t.count)},...b.value==="none"?[]:[{name:b.value==="yoy"?"销售额-同比":"销售额-环比",type:"line",smooth:!0,lineStyle:{type:"dashed"},data:Q.value.map(t=>t.amount)}]]}),z==null||z.setOption({title:{text:"采购趋势",left:"center"},tooltip:{trigger:"axis"},legend:{top:30,data:["采购额","单据数",b.value==="yoy"?"采购额-同比":b.value==="mom"?"采购额-环比":null].filter(Boolean)},dataZoom:[{type:"inside"},{type:"slider"}],xAxis:{type:"category",data:J.value.map(t=>t.key)},yAxis:[{type:"value",name:"金额(元)"},{type:"value",name:"单据数"}],series:[{name:"采购额",type:"line",smooth:!0,data:J.value.map(t=>t.amount)},{name:"单据数",type:"bar",yAxisIndex:1,data:J.value.map(t=>t.count)},...b.value==="none"?[]:[{name:b.value==="yoy"?"采购额-同比":"采购额-环比",type:"line",smooth:!0,lineStyle:{type:"dashed"},data:ee.value.map(t=>t.amount)}]]}),P==null||P.setOption({title:{text:"分类销售占比",left:"center"},tooltip:{trigger:"item",formatter:"{b}: {c} ({d}%)"},legend:{orient:"vertical",left:"left",top:"middle"},series:[{name:"销售额",type:"pie",radius:["40%","70%"],center:["60%","50%"],data:ne.value.map(t=>({name:t.category,value:t.sales}))}]});const c=W.value==="amount"?j.value.map(t=>t.amount):j.value.map(t=>t.qty),e=W.value==="amount"?"销售额":"销量";A==null||A.setOption({title:{text:"热销TOP（".concat(e,"）"),left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"value"},yAxis:{type:"category",data:j.value.map(t=>t.name)},series:[{name:e,type:"bar",data:c}]})},G=g("category"),be=async()=>{try{const[c,e]=U.value,{data:t}=await T.exportReports({start_date:c,end_date:e,type:G.value,format:"csv"}),u=new Blob([t],{type:"text/csv;charset=utf-8;"}),m=URL.createObjectURL(u),r=document.createElement("a");r.href=m,r.download="数据报表_".concat(G.value,"_").concat(c,"_to_").concat(e,".csv"),r.click(),URL.revokeObjectURL(m)}catch(c){ve.error((c==null?void 0:c.message)||"导出失败")}};return me([k,U],()=>{le()}),me(b,()=>{le()}),Se(()=>{we(),le(),window.addEventListener("resize",()=>{F==null||F.resize(),z==null||z.resize(),P==null||P.resize(),A==null||A.resize()})}),(c,e)=>{const t=h("el-date-picker"),u=h("el-form-item"),m=h("el-radio-button"),r=h("el-radio-group"),p=h("el-option"),n=h("el-select"),L=h("el-form"),N=h("el-button"),_=h("el-card"),y=h("el-col"),x=h("el-row"),M=h("el-table-column"),R=h("el-table"),E=$e("loading");return Me((Te(),Ye("div",Ne,[l("div",Re,[a(_,null,{default:o(()=>[l("div",Ve,[l("div",Fe,[a(L,{inline:""},{default:o(()=>[a(u,{label:"时间范围:"},{default:o(()=>[a(t,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=w=>U.value=w),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),a(u,{label:"粒度:"},{default:o(()=>[a(r,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=w=>k.value=w),size:"small"},{default:o(()=>[a(m,{label:"day"},{default:o(()=>[...e[5]||(e[5]=[O("日",-1)])]),_:1}),a(m,{label:"week"},{default:o(()=>[...e[6]||(e[6]=[O("周",-1)])]),_:1}),a(m,{label:"month"},{default:o(()=>[...e[7]||(e[7]=[O("月",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(u,{label:"对比:"},{default:o(()=>[a(n,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=w=>b.value=w),placeholder:"无",style:{width:"120px"}},{default:o(()=>[a(p,{label:"无",value:"none"}),a(p,{label:"同比",value:"yoy"}),a(p,{label:"环比",value:"mom"})]),_:1},8,["modelValue"])]),_:1}),a(u,{label:"导出类型:"},{default:o(()=>[a(n,{modelValue:G.value,"onUpdate:modelValue":e[3]||(e[3]=w=>G.value=w),style:{width:"140px"}},{default:o(()=>[a(p,{label:"概览",value:"overview"}),a(p,{label:"趋势",value:"trend"}),a(p,{label:"分类",value:"category"}),a(p,{label:"热销TOP",value:"top"}),a(p,{label:"尺码",value:"size"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),l("div",ze,[a(N,{type:"success",onClick:be},{icon:o(()=>[...e[8]||(e[8]=[l("i",{class:"ep:download"},null,-1)])]),default:o(()=>[e[9]||(e[9]=O("导出 ",-1))]),_:1})])])]),_:1})]),l("div",Pe,[a(x,{gutter:20},{default:o(()=>[a(y,{span:6},{default:o(()=>[a(_,{class:"overview-card"},{default:o(()=>[l("div",Ae,[l("div",Le,[l("div",Oe,"¥"+H(q.value.gmv.toLocaleString()),1),e[10]||(e[10]=l("div",{class:"overview-label"},"GMV",-1))])])]),_:1})]),_:1}),a(y,{span:6},{default:o(()=>[a(_,{class:"overview-card"},{default:o(()=>[l("div",Ee,[l("div",Be,[l("div",Ue,"¥"+H(q.value.netSales.toLocaleString()),1),e[11]||(e[11]=l("div",{class:"overview-label"},"净销售额",-1))])])]),_:1})]),_:1}),a(y,{span:6},{default:o(()=>[a(_,{class:"overview-card"},{default:o(()=>[l("div",qe,[l("div",Ie,[l("div",Ce,H(q.value.orders),1),e[12]||(e[12]=l("div",{class:"overview-label"},"订单数",-1))])])]),_:1})]),_:1}),a(y,{span:6},{default:o(()=>[a(_,{class:"overview-card"},{default:o(()=>[l("div",He,[l("div",Je,[l("div",We,"¥"+H(q.value.grossProfit.toLocaleString()),1),e[13]||(e[13]=l("div",{class:"overview-label"},"毛利",-1))])])]),_:1})]),_:1})]),_:1})]),l("div",je,[a(x,{gutter:20},{default:o(()=>[a(y,{span:12},{default:o(()=>[a(_,null,{default:o(()=>[l("div",{ref_key:"salesTrendRef",ref:te,class:"chart-container"},null,512)]),_:1})]),_:1}),a(y,{span:12},{default:o(()=>[a(_,null,{default:o(()=>[l("div",{ref_key:"purchaseTrendRef",ref:ae,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),a(x,{gutter:20,style:{"margin-top":"20px"}},{default:o(()=>[a(y,{span:12},{default:o(()=>[a(_,null,{default:o(()=>[l("div",{ref_key:"categoryRef",ref:oe,class:"chart-container"},null,512)]),_:1})]),_:1}),a(y,{span:12},{default:o(()=>[a(_,null,{header:o(()=>[l("div",Ge,[e[16]||(e[16]=l("span",null,"热销TOP",-1)),l("div",Ke,[a(r,{modelValue:W.value,"onUpdate:modelValue":e[4]||(e[4]=w=>W.value=w),size:"small"},{default:o(()=>[a(m,{label:"amount"},{default:o(()=>[...e[14]||(e[14]=[O("金额",-1)])]),_:1}),a(m,{label:"qty"},{default:o(()=>[...e[15]||(e[15]=[O("数量",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),default:o(()=>[l("div",{ref_key:"topRef",ref:se,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1})]),l("div",Xe,[a(x,{gutter:20},{default:o(()=>[a(y,{span:12},{default:o(()=>[a(_,null,{header:o(()=>[...e[17]||(e[17]=[l("div",{class:"card-header"},[l("span",null,"尺码热销榜")],-1)])]),default:o(()=>[a(R,{data:re.value,size:"small",border:""},{default:o(()=>[a(M,{prop:"size",label:"尺码",width:"120"}),a(M,{prop:"qty",label:"销量(件)",width:"120"}),a(M,{prop:"sales",label:"销售额(元)"},{default:o(({row:w})=>[O("¥"+H(w.sales.toFixed(2)),1)]),_:1})]),_:1},8,["data"])]),_:1})]),_:1}),a(y,{span:12},{default:o(()=>[a(_,null,{header:o(()=>[...e[18]||(e[18]=[l("div",{class:"card-header"},[l("span",null,"说明")],-1)])]),default:o(()=>[e[19]||(e[19]=l("div",{style:{color:"#909399","font-size":"12px"}},"分类树下钻、同比/环比曲线与导出XLSX将在后端导出与分类树API就绪后自动接入。本页已剥离日清月结相关内容，专注销售、采购、分类、趋势、尺码等统计。",-1))]),_:1})]),_:1})]),_:1})])])),[[E,Z.value]])}}});typeof _e=="function"&&_e(fe);const tt=ke(fe,[["__scopeId","data-v-544b24b9"]]);export{tt as default};
