name: Auto Build & Release

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Install Dependencies
        run: |
          pnpm install
          cd admin-frontend && pnpm install
          cd ../shop-frontend && pnpm install

      - name: Build Backend
        run: |
          chmod +x deploy-smoke-linux/init-db.sh
          echo "Backend prepared for deployment"

      - name: Build Admin Frontend
        working-directory: admin-frontend
        run: |
          pnpm build
          echo "Admin frontend build complete"

      - name: Build Shop Frontend
        working-directory: shop-frontend
        run: |
          pnpm build
          echo "Shop frontend build complete"

      - name: Package Database Init Files
        run: |
          mkdir -p release/config
          cp config/database.js release/config/
          cp deploy-smoke-linux/init-db.sh release/
          cd release && tar -czf ../db-init.tar.gz .
          echo "Database init files packaged"

      - name: Create Full Release Package
        run: |
          mkdir -p full-release
          cp -r admin-frontend/dist full-release/admin
          cp -r shop-frontend/dist full-release/shop
          cp db-init.tar.gz full-release/
          cp newserver.js full-release/
          cp package.json full-release/
          cp pnpm-lock.yaml full-release/
          cd full-release && tar -czf ../release.tar.gz .

      - name: Upload Admin Frontend
        uses: actions/upload-artifact@v4
        with:
          name: admin-frontend
          path: admin-frontend/dist
          compression-level: 9

      - name: Upload Shop Frontend
        uses: actions/upload-artifact@v4
        with:
          name: shop-frontend
          path: shop-frontend/dist
          compression-level: 9

      - name: Upload Database Init Files
        uses: actions/upload-artifact@v4
        with:
          name: db-init
          path: db-init.tar.gz
          compression-level: 9

      - name: Upload Full Release Package
        uses: actions/upload-artifact@v4
        with:
          name: full-release
          path: release.tar.gz
          compression-level: 9

      - name: Create GitHub Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release.tar.gz
            db-init.tar.gz
          name: Release ${{ github.sha }}
          tag_name: v${{ github.run_number }}
          body: |
            自动构建发布
            
            包含内容：
            - 管理后台前端
            - 商城前端
            - 后端服务
            - 数据库初始化文件
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
